#!/bin/bash

IFACE=$1         # Network interface, e.g., eth0
PLAN_FILE=$2     # Path to the plan file

if [[ -z "$IFACE" || -z "$PLAN_FILE" || ! -f "$PLAN_FILE" ]]; then
    echo "Usage: $0 <interface> <plan_file.txt>"
    exit 1
fi

# TBF defaults
BURST=32kbit
LATENCY=400ms

apply_bandwidth() {
    local rate=$1
    echo "Applying rate: $rate on $IFACE"

    # Delete any existing rule
    tc qdisc del dev $IFACE root 2>/dev/null

    # Apply new TBF rule
    tc qdisc add dev $IFACE root tbf rate $rate burst $BURST latency $LATENCY
}

while read -r duration rate; do
    [[ -z "$duration" || -z "$rate" ]] && continue
    apply_bandwidth "$rate"
    sleep "${duration}"
done < "$PLAN_FILE"

# Clean up
tc qdisc del dev $IFACE root 2>/dev/null
echo "Bandwidth plan completed and reset on $IFACE."
